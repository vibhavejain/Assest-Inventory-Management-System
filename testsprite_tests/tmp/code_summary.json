{
  "tech_stack": ["TypeScript", "Cloudflare Workers", "D1 Database (SQLite)", "Hono-style routing"],
  "business_rules": {
    "asset_deletion": {
      "rule": "Assets with activity history CANNOT be deleted. This is INTENTIONAL behavior for data integrity.",
      "expected_response": {"success": false, "error": {"code": "BAD_REQUEST", "message": "Cannot delete asset with activity history"}},
      "test_guidance": "When testing DELETE /assets/{id}, if the asset has any audit log entries or activity history, expect a 400 response with the above error. Do NOT treat this as a test failure - it is correct behavior. To test successful deletion, use a freshly created asset with no activity."
    },
    "audit_logs_require_company": {
      "rule": "The GET /audit-logs endpoint REQUIRES a company_id query parameter. This is by design for security scoping.",
      "expected_error_without_company_id": {"success": false, "error": {"code": "BAD_REQUEST", "message": "company_id query parameter is required"}},
      "test_guidance": "Always include ?company_id=<valid-uuid> when calling GET /audit-logs. First create a company, then use its ID to fetch audit logs."
    },
    "company_access_deletion": {
      "rule": "DELETE /companies/{companyId}/users/{userId} returns HTTP 204 No Content on success, NOT 200.",
      "expected_status_code": 204,
      "test_guidance": "When testing DELETE to revoke company access, expect status code 204 (not 200). The response body will be empty. Example: assert resp.status_code == 204"
    }
  },
  "response_format": {
    "description": "CRITICAL: All API responses are wrapped in {success: bool, data: {...}}. You MUST extract IDs from the nested 'data' object.",
    "python_helper_functions": {
      "extract_id": "def get_id(response):\n    resp_json = response.json()\n    return resp_json.get('data', resp_json).get('id')",
      "extract_list": "def get_list(response):\n    resp_json = response.json()\n    return resp_json.get('data', resp_json)",
      "usage_example": "# After POST /companies:\nresp = requests.post(url, json=payload)\ncompany_id = resp.json().get('data', {}).get('id')  # CORRECT\n# company_id = resp.json().get('id')  # WRONG - will return None"
    },
    "success_response": {
      "structure": {"success": true, "data": {"id": "uuid", "...other_fields": "..."}},
      "example": {"success": true, "data": {"id": "7ecfeafc-7d8e-40fd-958a-908f9a3fc7a8", "name": "Test Company", "status": "active", "created_at": "2026-01-06T09:50:57.445Z"}}
    },
    "list_response": {
      "structure": {"success": true, "data": ["array of items"], "meta": {"total": 0, "limit": 50, "page": 1}}
    },
    "error_response": {
      "structure": {"success": false, "error": {"code": "ERROR_CODE", "message": "Error message", "details": {}}}
    },
    "IMPORTANT_REMINDER": "NEVER use resp.json().get('id'). ALWAYS use resp.json().get('data', {}).get('id')"
  },
  "features": [
    {
      "name": "Health Check API",
      "description": "Returns the health status of the API service",
      "files": ["src/index.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/health": {
            "get": {
              "summary": "Health check endpoint",
              "responses": {
                "200": {
                  "description": "Service is healthy",
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "status": { "type": "string", "example": "ok" },
                          "timestamp": { "type": "string", "format": "date-time" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "name": "Companies API",
      "description": "CRUD operations for managing companies",
      "files": ["src/routes/companies.ts", "src/db/companies.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/companies": {
            "get": {
              "summary": "List all companies",
              "parameters": [
                { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } },
                { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } },
                { "name": "status", "in": "query", "schema": { "type": "string" } }
              ],
              "responses": {
                "200": { "description": "List of companies with pagination metadata" }
              }
            },
            "post": {
              "summary": "Create a new company",
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object",
                      "required": ["name"],
                      "properties": {
                        "name": { "type": "string" },
                        "description": { "type": "string" },
                        "status": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "responses": {
                "201": { "description": "Company created successfully" },
                "400": { "description": "Validation error or duplicate name" }
              }
            }
          },
          "/companies/{id}": {
            "get": {
              "summary": "Get company by ID",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "Company details" },
                "404": { "description": "Company not found" }
              }
            },
            "patch": {
              "summary": "Update company",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "requestBody": {
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object",
                      "properties": {
                        "name": { "type": "string" },
                        "description": { "type": "string" },
                        "status": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "responses": {
                "200": { "description": "Company updated" },
                "404": { "description": "Company not found" }
              }
            },
            "delete": {
              "summary": "Delete company",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "Company deleted" },
                "404": { "description": "Company not found" }
              }
            }
          }
        }
      }
    },
    {
      "name": "Users API",
      "description": "CRUD operations for managing users",
      "files": ["src/routes/users.ts", "src/db/users.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/users": {
            "get": {
              "summary": "List all users",
              "parameters": [
                { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } },
                { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } },
                { "name": "status", "in": "query", "schema": { "type": "string" } },
                { "name": "company_id", "in": "query", "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "List of users with pagination metadata" }
              }
            },
            "post": {
              "summary": "Create a new user",
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object",
                      "required": ["email", "name"],
                      "properties": {
                        "email": { "type": "string", "format": "email" },
                        "name": { "type": "string" },
                        "primary_company_id": { "type": "string", "format": "uuid" },
                        "status": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "responses": {
                "201": { "description": "User created successfully" },
                "400": { "description": "Validation error or duplicate email" }
              }
            }
          },
          "/users/{id}": {
            "patch": {
              "summary": "Update user",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "User updated" },
                "404": { "description": "User not found" }
              }
            },
            "delete": {
              "summary": "Delete user",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "User deleted" },
                "404": { "description": "User not found" }
              }
            }
          },
          "/users/{id}/companies": {
            "get": {
              "summary": "Get user's company assignments",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "List of companies the user belongs to" },
                "404": { "description": "User not found" }
              }
            }
          },
          "/users/{id}/audit-logs": {
            "get": {
              "summary": "Get user's audit logs",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
                { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } },
                { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
              ],
              "responses": {
                "200": { "description": "List of audit logs for the user" },
                "404": { "description": "User not found" }
              }
            }
          }
        }
      }
    },
    {
      "name": "Assets API",
      "description": "CRUD operations for managing assets",
      "files": ["src/routes/assets.ts", "src/db/assets.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/assets": {
            "get": {
              "summary": "List all assets",
              "parameters": [
                { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } },
                { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } },
                { "name": "company_id", "in": "query", "schema": { "type": "string", "format": "uuid" } },
                { "name": "type", "in": "query", "schema": { "type": "string" } },
                { "name": "status", "in": "query", "schema": { "type": "string" } }
              ],
              "responses": {
                "200": { "description": "List of assets with pagination metadata" }
              }
            },
            "post": {
              "summary": "Create a new asset",
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object",
                      "required": ["name", "company_id", "type"],
                      "properties": {
                        "name": { "type": "string" },
                        "company_id": { "type": "string", "format": "uuid" },
                        "type": { "type": "string" },
                        "description": { "type": "string" },
                        "status": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "responses": {
                "201": { "description": "Asset created successfully" },
                "400": { "description": "Validation error or company not found" }
              }
            }
          },
          "/assets/{id}": {
            "patch": {
              "summary": "Update asset",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "Asset updated" },
                "404": { "description": "Asset not found" }
              }
            },
            "delete": {
              "summary": "Delete asset",
              "parameters": [
                { "name": "id", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "Asset deleted" },
                "404": { "description": "Asset not found" }
              }
            }
          }
        }
      }
    },
    {
      "name": "Company Access API",
      "description": "Manage user access to companies",
      "files": ["src/routes/company-access.ts", "src/db/company-access.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/companies/{companyId}/users": {
            "get": {
              "summary": "List users with access to a company",
              "parameters": [
                { "name": "companyId", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "List of users with company access" },
                "404": { "description": "Company not found" }
              }
            },
            "post": {
              "summary": "Grant user access to company",
              "parameters": [
                { "name": "companyId", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "requestBody": {
                "required": true,
                "content": {
                  "application/json": {
                    "schema": {
                      "type": "object",
                      "required": ["user_id", "role"],
                      "properties": {
                        "user_id": { "type": "string", "format": "uuid" },
                        "role": { "type": "string" }
                      }
                    }
                  }
                }
              },
              "responses": {
                "201": { "description": "Access granted" },
                "400": { "description": "Validation error" }
              }
            }
          },
          "/companies/{companyId}/users/{userId}": {
            "delete": {
              "summary": "Revoke user access from company",
              "parameters": [
                { "name": "companyId", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } },
                { "name": "userId", "in": "path", "required": true, "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "Access revoked" },
                "404": { "description": "Access not found" }
              }
            }
          }
        }
      }
    },
    {
      "name": "Audit Logs API",
      "description": "View audit logs for tracking changes",
      "files": ["src/routes/audit-logs.ts", "src/db/audit.ts"],
      "api_doc": {
        "openapi": "3.0.0",
        "paths": {
          "/audit-logs": {
            "get": {
              "summary": "List audit logs",
              "parameters": [
                { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } },
                { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } },
                { "name": "entity_type", "in": "query", "schema": { "type": "string" } },
                { "name": "entity_id", "in": "query", "schema": { "type": "string", "format": "uuid" } }
              ],
              "responses": {
                "200": { "description": "List of audit logs with pagination metadata" }
              }
            }
          }
        }
      }
    }
  ]
}
